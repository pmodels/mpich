/*
 * Copyright (C) by Argonne National Laboratory
 *     See COPYRIGHT in top-level directory
 */

# This file lists all collective algorithms with annotations. It is used by
# maint/gen_coll.py to generate src/mpi/coll/mpir_coll.c, which implements
# top-level collective functions, such as (using bcast for example) --
#     MPIR_Bcast, MPIR_Bcast_impl, MPIR_Bcast_allcomm_auto,
#     MPIR_Ibcast, MPIR_Ibcast_impl, MPIR_Ibcast_sched_impl, MPIR_Ibcast_allcomm_sched_auto,
#     MPIR_Bcast_init, MPIR_Bcast_init_impl
#
# The format is (reference actual examples) --
#
# [func-commkind]
#     [algorithm_name]
#         [key]: [values]
#
# "func-commkind" may be "general", under which the "algorithm_name" is the full name of the
# algorithm function. General algorithm functions takes (coll_sig, cnt) parameters.
#
# In addition, "conditions" list all conditions and their corresponding checkers. There are
# a few types of conditions distinguished by the format:
#   - conidtion_name: func
#         The condition calls checker function with signature: bool (*func)(coll_sig).
#   - condition_name(thresh): func
#         This condition calls a query function that returns a value: int (*func)(coll_sig)
#         The thresh marks the upper limit (inclusive) of the condition.
#   - func can optionally have a macro-guard, e.g. func #if defined(MPIDI_CH4_SHM_POSIX).
#         A wrapper checker function will be generated that wraps the "func" within macro-guard.
# The conditions are used in specifying both algorithm restrictions and CSEL conditions.
# Example usage in restriction list or JSON file: inplace, !inplace, avg_msg_size(1024), etc.
# Most of the checker functions should be inlined to minimize function call overhead.
#
# Notes:
#   * indentations (use 4 spaces) and ':' behind keys are significant
#   * auto and nb algorithms are assumed and not listed
#   * most collectives have 4 variations: blocking/nonblocking-intra/inter,
#     but some don't have intercomm variations (scan, exscan, and neighborhood collectives).
#   * arbitrary keys are allowed in the format as long as it observes indentation and colon.
#
# Recognized attribute keys (by gen_coll.py):
#   * restrictions:
#         A comma-separated list restrictions. All restrictions must be specified in the top
#         conditions list.
#   * extra_params and cvar_params:
#         Additional parameters specific to the algorithm functions. Most algorithm functions
#         use the same arguments (e.g. as MPIR_Bcast), but some may require additional
#         parameters. For csel selections, they are supplied int the container structure (with
#         field name listed in extraparams). For CVAR direct algorithm, they are supplied with
#         CVAR names listed in cvar_params (without the common prefix).
#         Both extra_params and cvar_params must have the same number of parameters and with
#         the same order. In addition, some of the extra parameter can be constant by specify
#         a initialization, e.g. param1=val. Rather than repeating the same constant in the
#         cvar_params, we can use `-` as placeholder for the corresponding constant param.

# ----
conditions:
    inplace:          MPIR_Csel_sendbuf_inplace
    pof2:             MPIR_Csel_comm_size_is_pof2
    commutative:      MPIR_Csel_op_is_commutative
    builtin_op:       MPIR_Csel_op_is_builtin
    hierarchical:     MPIR_Csel_is_hierarchical
    node_consecutive: MPIR_Csel_is_node_consecutive
    node_regular:     MPIR_Csel_is_node_canonical
    count_ge_pof2:    MPIR_Csel_count_ge_pof2
    displs_ordered:   MPIR_Csel_displs_ordered
    block_regular:    MPIR_Csel_block_regular
    comm_size(thresh):      MPIR_Csel_comm_size
    avg_msg_size(thresh):   MPIR_Csel_avg_msg_size
    total_msg_size(thresh): MPIR_Csel_total_msg_size

    # conditional conditions - only call the condition function under macro_guard
    MPIDI_CH4_release_gather: MPIDI_POSIX_check_release_gather #if defined(MPIDI_CH4_SHM_POSIX)

# ----
general:
    MPIR_Coll_auto
    MPIR_Coll_nb

# ----
barrier-intra:
    k_dissemination
        extra_params: k
        cvar_params: DISSEM_KVAL
    recexch
        extra_params: k, single_phase_recv
        cvar_params: RECEXCH_KVAL, RECEXCH_SINGLE_PHASE_RECV
    smp
        restrictions: hierarchical
    release_gather
        func_name: MPIDI_POSIX_mpi_barrier_release_gather
        inline: 1
        macro_guard: defined(MPIDI_CH4_SHM_POSIX)
        restrictions: MPIDI_CH4_release_gather
barrier-inter:
    bcast
ibarrier-intra:
    sched_recursive_doubling
    tsp_recexch
        extra_params: k
        cvar_params: RECEXCH_KVAL
    tsp_k_dissemination
        extra_params: k
        cvar_params: DISSEM_KVAL
ibarrier-inter:
    sched_bcast

bcast-intra:
    binomial
    scatter_recursive_doubling_allgather
    scatter_ring_allgather
    smp
        restrictions: hierarchical
    tree
        extra_params: tree_type, k, is_non_blocking
        cvar_params: TREE_TYPE, TREE_KVAL, IS_NON_BLOCKING
    pipelined_tree
        extra_params: tree_type, k, is_non_blocking, chunk_size, recv_pre_posted
        cvar_params: TREE_TYPE, TREE_KVAL, IS_NON_BLOCKING, TREE_PIPELINE_CHUNK_SIZE, RECV_PRE_POST 
    release_gather
        func_name: MPIDI_POSIX_mpi_bcast_release_gather
        inline: 1
        macro_guard: defined(MPIDI_CH4_SHM_POSIX)
        restrictions: MPIDI_CH4_release_gather
ibcast-intra:
    sched_binomial
    sched_smp
        restrictions: hierarchical
    sched_scatter_recursive_doubling_allgather
        restrictions: pof2
    sched_scatter_ring_allgather
    tsp_tree
        extra_params: tree_type, k, chunk_size
        cvar_params: TREE_TYPE, TREE_KVAL, TREE_PIPELINE_CHUNK_SIZE
    tsp_scatterv_allgatherv
        extra_params: use_ring=0, scatterv_k, allgatherv_k
        cvar_params: -, SCATTERV_KVAL, ALLGATHERV_RECEXCH_KVAL
    tsp_scatterv_recexch_allgatherv
        extra_params: scatterv_k, allgatherv_k
        cvar_params: SCATTERV_KVAL, ALLGATHERV_RECEXCH_KVAL
    tsp_scatterv_ring_allgatherv
        extra_params: scatterv_k
        cvar_params:  SCATTERV_KVAL
    tsp_ring
        extra_params: chunk_size
        cvar_params: RING_CHUNK_SIZE
bcast-inter:
    remote_send_local_bcast
ibcast-inter:
    sched_flat

gather-intra:
    binomial
gather-inter:
    linear
    local_gather_remote_send
igather-intra:
    sched_binomial
    tsp_tree
        extra_params: k
        cvar_params: TREE_KVAL
igather-inter:
    sched_long
    sched_short

gatherv-intra:
    linear
        allcomm: 1
gatherv-inter:
    linear
        allcomm: 1
igatherv-intra:
    sched_linear
        allcomm: 1
    tsp_linear
        allcomm: 1
igatherv-inter:
    sched_linear
        allcomm: 1
    tsp_linear
        allcomm: 1

scatter-intra:
    binomial
scatter-inter:
    linear
    remote_send_local_scatter
iscatter-intra:
    sched_binomial
    tsp_tree
        extra_params: k
        cvar_params: TREE_KVAL
iscatter-inter:
    sched_linear
    sched_remote_send_local_scatter

scatterv-intra:
    linear
        allcomm: 1
scatterv-inter:
    linear
        allcomm: 1
iscatterv-intra:
    sched_linear
        allcomm: 1
    tsp_linear
        allcomm: 1
iscatterv-inter:
    sched_linear
        allcomm: 1
    tsp_linear
        allcomm: 1

allgather-intra:
    brucks
    k_brucks
        extra_params: k
        cvar_params: BRUCKS_KVAL
    recursive_doubling
        restrictions: pof2
    ring
    recexch_doubling
        extra_params: k, single_phase_recv
        cvar_params: RECEXCH_KVAL, RECEXCH_SINGLE_PHASE_RECV
    recexch_halving
        extra_params: k, single_phase_recv
        cvar_params: RECEXCH_KVAL, RECEXCH_SINGLE_PHASE_RECV
allgather-inter:
    local_gather_remote_bcast
iallgather-intra:
    sched_ring
    sched_brucks
    sched_recursive_doubling
        restrictions: pof2
    tsp_ring
    tsp_brucks
        extra_params: k
        cvar_params: BRUCKS_KVAL
    tsp_recexch_doubling
        extra_params: k
        cvar_params: RECEXCH_KVAL
    tsp_recexch_halving
        extra_params: k
        cvar_params: RECEXCH_KVAL
iallgather-inter:
    sched_local_gather_remote_bcast

allgatherv-intra:
    brucks
    recursive_doubling
        restrictions: pof2
    ring
allgatherv-inter:
    remote_gather_local_bcast
iallgatherv-intra:
    sched_brucks
    sched_recursive_doubling
        restrictions: pof2
    sched_ring
    tsp_recexch_doubling
        restrictions: displs_ordered
        extra_params: k
        cvar_params: RECEXCH_KVAL
    tsp_recexch_halving
        restrictions: displs_ordered
        extra_params: k
        cvar_params: RECEXCH_KVAL
    tsp_ring
    tsp_brucks
        extra_params: k
        cvar_params: BRUCKS_KVAL
iallgatherv-inter:
    sched_remote_gather_local_bcast

alltoall-intra:
    brucks
        restrictions: !inplace
    k_brucks
        restrictions: !inplace
        extra_params: k
        cvar_params: BRUCKS_KVAL
    pairwise
        restrictions: !inplace
    pairwise_sendrecv_replace
        restrictions: inplace
    scattered
        restrictions: !inplace
alltoall-inter:
    pairwise_exchange
ialltoall-intra:
    sched_brucks
        restrictions: !inplace
    sched_inplace
        restrictions: inplace
    sched_pairwise
        restrictions: !inplace
    sched_permuted_sendrecv
        restrictions: !inplace
    tsp_ring
    tsp_brucks
        extra_params: k, buffer_per_phase
        cvar_params: BRUCKS_KVAL, BRUCKS_BUFFER_PER_NBR
    tsp_scattered
        extra_params: batch_size, bblock
        cvar_params: SCATTERED_BATCH_SIZE, SCATTERED_OUTSTANDING_TASKS
ialltoall-inter:
    sched_pairwise_exchange

alltoallv-intra:
    pairwise_sendrecv_replace
        restrictions: inplace
    scattered
        restrictions: !inplace
alltoallv-inter:
    pairwise_exchange
ialltoallv-intra:
    sched_blocked
        restrictions: !inplace
    sched_inplace
        restrictions: inplace
    tsp_scattered
        restrictions: !inplace
        extra_params: batch_size, bblock
        cvar_params: SCATTERED_BATCH_SIZE, SCATTERED_OUTSTANDING_TASKS
    tsp_blocked
        restrictions: !inplace
        extra_params: bblock
        cvar_params: THROTTLE
    tsp_inplace
        restrictions: inplace
ialltoallv-inter:
    sched_pairwise_exchange

alltoallw-intra:
    pairwise_sendrecv_replace
        restrictions: inplace
    scattered
        restrictions: !inplace
alltoallw-inter:
    pairwise_exchange
ialltoallw-intra:
    sched_blocked
        restrictions: !inplace
    sched_inplace
        restrictions: inplace
    tsp_blocked
        restrictions: !inplace
        extra_params: bblock
        cvar_params: THROTTLE
    tsp_inplace
        restrictions: inplace
ialltoallw-inter:
    sched_pairwise_exchange

reduce-intra:
    binomial
    smp
        restrictions: commutative, hierarchical
    reduce_scatter_gather
        restrictions: count_ge_pof2, builtin_op
    release_gather
        func_name: MPIDI_POSIX_mpi_reduce_release_gather
        inline: 1
        macro_guard: defined(MPIDI_CH4_SHM_POSIX)
        restrictions: MPIDI_CH4_release_gather
reduce-inter:
    local_reduce_remote_send
ireduce-intra:
    sched_smp
        restrictions: commutative, hierarchical
    sched_binomial
    sched_reduce_scatter_gather
        restrictions: count_ge_pof2, builtin_op
    tsp_tree
        restrictions: commutative
        extra_params: tree_type, k, chunk_size, buffer_per_child
        cvar_params: TREE_TYPE, TREE_KVAL, TREE_PIPELINE_CHUNK_SIZE, TREE_BUFFER_PER_CHILD
    tsp_ring
        extra_params: chunk_size, buffer_per_child
        cvar_params: RING_CHUNK_SIZE, TREE_BUFFER_PER_CHILD
ireduce-inter:
    sched_local_reduce_remote_send

allreduce-intra:
    smp
        restrictions: commutative, hierarchical
    recursive_doubling
    recursive_multiplying
        extra_params: k
        cvar_params: RECURSIVE_MULTIPLYING_KVAL
        restrictions: commutative
    reduce_scatter_allgather
        restrictions: count_ge_pof2, builtin_op
    tree
        extra_params: tree_type, k, chunk_size, buffer_per_child
        cvar_params: TREE_TYPE, TREE_KVAL, TREE_PIPELINE_CHUNK_SIZE, TREE_BUFFER_PER_CHILD
    recexch
        extra_params: k, single_phase_recv
        cvar_params: RECEXCH_KVAL, RECEXCH_SINGLE_PHASE_RECV
    ring
        restrictions: commutative
    k_reduce_scatter_allgather
        restrictions: commutative
        extra_params: k, single_phase_recv
        cvar_params: RECEXCH_KVAL, RECEXCH_SINGLE_PHASE_RECV
    ccl
        extra_params: ccl
        cvar_params: CCL
    release_gather
        func_name: MPIDI_POSIX_mpi_allreduce_release_gather
        inline: 1
        macro_guard: defined(MPIDI_CH4_SHM_POSIX)
        restrictions: MPIDI_CH4_release_gather
allreduce-inter:
    reduce_exchange_bcast
iallreduce-intra:
    sched_naive
    sched_smp
        restrictions: commutative, hierarchical
    sched_recursive_doubling
    sched_reduce_scatter_allgather
        restrictions: count_ge_pof2, builtin_op
    tsp_recexch_single_buffer
        extra_params: k
        cvar_params: RECEXCH_KVAL
    tsp_recexch_multiple_buffer
        extra_params: k
        cvar_params: RECEXCH_KVAL
    tsp_recexch
        extra_params: per_nbr_buffer=1, k
        cvar_params: -, RECEXCH_KVAL
    tsp_tree
        extra_params: tree_type, k, chunk_size, buffer_per_child
        cvar_params: TREE_TYPE, TREE_KVAL, TREE_PIPELINE_CHUNK_SIZE, TREE_BUFFER_PER_CHILD
    tsp_ring
        restrictions: commutative
    tsp_recexch_reduce_scatter_recexch_allgatherv
        restrictions: commutative
        extra_params: k
        cvar_params: RECEXCH_KVAL
iallreduce-inter:
    sched_remote_reduce_local_bcast

reduce_scatter-intra:
    noncommutative
    pairwise
        restrictions: commutative
    recursive_doubling
    recursive_halving
        restrictions: commutative
reduce_scatter-inter:
    remote_reduce_local_scatter
ireduce_scatter-intra:
    sched_noncommutative
        restrictions: pof2
    sched_recursive_doubling
    sched_pairwise
        restrictions: commutative
    sched_recursive_halving
        restrictions: commutative
    tsp_recexch
        restrictions: commutative
        extra_params: is_dist_halving=0, k
        cvar_params: -, RECEXCH_KVAL
ireduce_scatter-inter:
    sched_remote_reduce_local_scatterv

reduce_scatter_block-intra:
    noncommutative
        restrictions: pof2
    recursive_doubling
    pairwise
        restrictions: commutative
    recursive_halving
        restrictions: commutative
reduce_scatter_block-inter:
    remote_reduce_local_scatter
ireduce_scatter_block-intra:
    sched_noncommutative
        restrictions: pof2
    sched_recursive_doubling
    sched_pairwise
        restrictions: commutative
    sched_recursive_halving
        restrictions: commutative
    tsp_recexch
        restrictions: commutative
        extra_params: k
        cvar_params: RECEXCH_KVAL
ireduce_scatter_block-inter:
    sched_remote_reduce_local_scatterv

scan-intra:
    smp
        restrictions: commutative, node_consecutive
    recursive_doubling
iscan-intra:
    sched_smp
        restrictions: commutative, node_consecutive
    sched_recursive_doubling
    tsp_recursive_doubling

exscan-intra:
    recursive_doubling
iexscan-intra:
    sched_recursive_doubling

neighbor_allgather-intra:
ineighbor_allgather-intra:
    sched_linear
        allcomm: 1
    tsp_linear
        allcomm: 1
neighbor_allgatherv-intra:
ineighbor_allgatherv-intra:
    sched_linear
        allcomm: 1
    tsp_linear
        allcomm: 1
neighbor_alltoall-intra:
ineighbor_alltoall-intra:
    sched_linear
        allcomm: 1
    tsp_linear
        allcomm: 1
neighbor_alltoallv-intra:
ineighbor_alltoallv-intra:
    sched_linear
        allcomm: 1
    tsp_linear
        allcomm: 1
neighbor_alltoallw-intra:
ineighbor_alltoallw-intra:
    sched_linear
        allcomm: 1
    tsp_linear
        allcomm: 1
