##
## Copyright (C) by Argonne National Laboratory
##     See COPYRIGHT in top-level directory
##

if ROMIO_INSIDE_OMPI
AM_CPPFLAGS = \
        -I@main_top_srcdir@ \
        -I@main_top_srcdir@/opal/include \
        -I@main_top_builddir@/opal/include \
        -I@main_top_builddir@/ompi/include \
        -I$(top_srcdir)/include \
        -I$(top_srcdir)/adio/include
else
if ROMIO_INSIDE_MPICH
# when building under MPICH we must be able to find mpi.h
AM_CPPFLAGS = -I@main_top_builddir@/src/include -I@main_top_srcdir@/src/include
else
AM_CPPFLAGS =
endif
endif


## TODO: need to write an automakefile that handles two primary cases:
## 1) that ROMIO is being embedded within the MPI library, as in MPICH or Open
##    MPI
## 2) that ROMIO is being built standalone, old-school style.  This case is
##    basically unused in modern practice.

# help autoreconf and friends realize where the macros live
ACLOCAL_AMFLAGS = -I confdb

# empty variable initializations so that later code can append (+=)
include_HEADERS = 
nodist_include_HEADERS =
noinst_HEADERS = 
AM_CFLAGS = @VISIBILITY_CFLAGS@
EXTRA_DIST =
SUFFIXES = 
doc1_src_txt =

external_subdirs = @mpl_srcdir@
external_dist_subdirs = @mpl_dist_srcdir@
external_includes = @mpl_includedir@
external_ldflags = @mpl_libdir@
external_libs = @mpl_lib@

# ------------------------------------------------------------------------
# variables to be populated by the included Makefile.mk fragments:

# These are files that contain MPI routines (e.g., MPI_File_open).
# In MPICH these will have an MPI_ and a PMPI_ version.  Other implementations
# (like OMPI) only want these to be MPI_ routines, possibly with some
# name-shifting prefix.
romio_mpi_sources = 

# regular old source files that implement ROMIO, such as ADIO code
romio_other_sources =

# code that may need to be "up" called from the MPI library and/or is
# MPI-implementation-specific in some way
glue_sources = 

# ------------------------------------------------------------------------
# handle the "include" directory here
AM_CPPFLAGS += -I$(top_builddir)/include -I$(top_srcdir)/include $(external_includes)
AM_CPPFLAGS += -I$(top_srcdir)/adio/include
# nodist_ b/c these are created by config.status and should not be distributed
nodist_include_HEADERS += include/mpio.h
noinst_HEADERS += include/ompi_grequestx.h include/io_romio_conv.h

# ------------------------------------------------------------------------

SUBDIRS = $(external_subdirs) . test
DIST_SUBDIRS = test test-internal $(external_dist_subdirs)

# for the sake of parallel make and avoiding an excessive number of convenience
# libs, we use a subdir automake fragment strategy
include mpi-io/Makefile.mk
include adio/Makefile.mk

EXTRA_DIST += autogen.sh

if BUILD_ROMIO_EMBEDDED
# Build a libtool convenience library that the enclosing MPI implementation can
# use by adding it to the right _LIBADD variable.
if ROMIO_INSIDE_OMPI
noinst_LTLIBRARIES = libromio_dist.la
libromio_dist_la_SOURCES = $(romio_mpi_sources) $(romio_other_sources) $(glue_sources)
else
noinst_LTLIBRARIES = libromio.la
libromio_la_SOURCES = $(romio_mpi_sources) $(romio_other_sources) $(glue_sources)
endif

## NOTE: ROMIO's old build system builds a bunch of _foo.o objects that contain
## PMPI_ implementations as well as calls to only other PMPI routines.  In
## MPICH, these are the objects that need to go into libmpi, while the foo.o
## objects should go into libpmpi.  Furthermore, the -D option for ROMIO's
## source files is different and inverted (in the boolean sense) compared with
## MPICH's definition.  And ROMIO was dumping all of the symbols into the main
## libmpi library, regardless of the separate profiling library's existence.
##
## Annoying, right?
if BUILD_PROFILING_LIB
# The current best strategy for now is to build the PMPI symbols as a separate
# convenience lib, libpromio.la, to permit adding the special "-D..." argument
# for all objects. MPICH will then link in both convenience libraries,
# libromio.la and libpromio.la, into libmpi, since it won't work very well the
# other way around.
# $(romio_mpi_sources) are the ones needed to be built twice. Once in
# libromio.la without -DMPIO_BUILD_PROFILING and the other in libpromio.la.
noinst_LTLIBRARIES += libpromio.la
libpromio_la_SOURCES = $(romio_mpi_sources)
libpromio_la_CPPFLAGS = $(AM_CPPFLAGS) -DMPIO_BUILD_PROFILING
libpromio_la_LDFLAGS = $(external_ldflags)
libpromio_la_LIBADD = $(external_libs)
else !BUILD_PROFILING_LIB
if ROMIO_INSIDE_OMPI
libromio_dist_la_LDFLAGS = $(external_ldflags)
libromio_dist_la_LIBADD = $(external_libs)
else !ROMIO_INSIDE_OMPI
libromio_la_LDFLAGS = $(external_ldflags)
libromio_la_LIBADD = $(external_libs)
endif !ROMIO_INSIDE_OMPI
endif !BUILD_PROFILING_LIB

if BUILD_ABI_LIB
noinst_LTLIBRARIES += libromio_abi.la
libromio_abi_la_SOURCES = $(romio_mpi_sources) $(romio_other_sources) $(glue_sources)
libromio_abi_la_CPPFLAGS = $(AM_CPPFLAGS) -DBUILD_MPI_ABI

if BUILD_PROFILING_LIB
noinst_LTLIBRARIES += libpromio_abi.la
libpromio_abi_la_SOURCES = $(romio_mpi_sources)
libpromio_abi_la_CPPFLAGS = $(AM_CPPFLAGS) -DMPIO_BUILD_PROFILING -DBUILD_MPI_ABI
libpromio_abi_la_LDFLAGS = $(external_ldflags)
libpromio_abi_la_LIBADD = $(external_libs)
endif BUILD_PROFILING_LIB
libromio_abi_la_LDFLAGS = $(external_ldflags)
libromio_abi_la_LIBADD = $(external_libs)
endif BUILD_ABI_LIB

# ---------------------------
else !BUILD_ROMIO_EMBEDDED
lib_LTLIBRARIES = libromio.la
libromio_la_SOURCES = $(romio_other_sources) $(glue_sources)
if BUILD_PROFILING_LIB
# $(romio_mpi_sources) are the ones needed to be built twice.
noinst_LTLIBRARIES = libpromio.la
libpromio_la_SOURCES = $(romio_mpi_sources)
libpromio_la_CPPFLAGS = $(AM_CPPFLAGS) -DMPIO_BUILD_PROFILING
libpromio_la_LDFLAGS = $(external_ldflags)
libpromio_la_LIBADD = $(external_libs)
libromio_la_LIBADD = libpromio.la
else !BUILD_PROFILING_LIB
libromio_la_SOURCES += $(romio_mpi_sources)
endif !BUILD_PROFILING_LIB
endif

# --------------------------------------------------------------------------
.PHONY: coverage
gcov_sources = $(libmpl_la_SOURCES)
# assumes that these sources were compiled appropriately ("-fprofile-arcs"
# and "-ftest-coverage")
coverage:
	@for file in $(gcov_sources) ; do \
	    dir=`dirname $$file` ; \
	    bname=`basename $$file` ; \
	    aux=`echo $$bname | sed -e 's,\.*$$,,'` ; \
	    echo "( $(GCOV) -b -f -o $$file $$file && mv $${bname}.gcov $$dir )" ; \
	    ( $(GCOV) -b -f -o $$file $$file && mv $${bname}.gcov $$dir ) ; \
	    rm -f *.gcov ; \
	done
	for subdir in $(SUBDIRS) - ; do \
	    if test $$subdir = "-" ; then break ; fi ; \
	    ( cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) coverage ) ; \
	done
# --------------------------------------------------------------------------
.PHONY: mandoc mandoc-local htmldoc htmldoc-local
SUFFIXES += .man-phony .html-phony .man1-phony .html1-phony .txt

# "make V=1" support for our documentation recipes
doctextman_verbose = $(doctextman_verbose_$(V))
doctextman_verbose_ = $(doctextman_verbose_$(AM_DEFAULT_VERBOSITY))
doctextman_verbose_0 = @echo "   DOCTEXTMAN  " $@;
doctexthtml_verbose = $(doctexthtml_verbose_$(V))
doctexthtml_verbose_ = $(doctexthtml_verbose_$(AM_DEFAULT_VERBOSITY))
doctexthtml_verbose_0 = @echo "   DOCTEXTHTML  " $@;

# Build dir paths where the man pages will be created.  Will usually be
# overridden by MPICH make.
mandoc_path1=$(abs_top_builddir)/man/man1
mandoc_path3=$(abs_top_builddir)/man/man3
htmldoc_path1=$(abs_top_builddir)/www/www1
htmldoc_path3=$(abs_top_builddir)/www/www3
doctext_docnotes=
# Provide an easily replaced url root for the generated index file.
# You can override this with URL desired in the index file generated by doctext.
# You can ignore this if you don't use mapnames or tohtml to add links
# to the MPI manual pages to documents.
htmldoc_root3="--your-url-here--"

.c.man-phony:
	$(doctextman_verbose)$(DOCTEXT) -man -mpath $(mandoc_path3) -ext 3 \
	    -heading MPI -quotefmt -nolocation $(doctext_docnotes) $<
.c.html-phony:
	$(doctexthtml_verbose)$(DOCTEXT) -html -mpath $(htmldoc_path3) \
	    -heading MPI -quotefmt -nolocation \
	    -index $(htmldoc_path3)/mpi.cit -indexdir $(htmldoc_root3) \
		$(doctext_docnotes) $<

.txt.man1-phony:
	$(doctextman_verbose)$(DOCTEXT) -man -mpath $(mandoc_path1) -ext 1 \
	    -heading MPI -quotefmt -nolocation $(doctext_docnotes) $<
.txt.html1-phony:
	$(doctexthtml_verbose)$(DOCTEXT) -html -mpath $(htmldoc_path1) \
	    -heading MPI -quotefmt -nolocation $(doctext_docnotes) $<

# use mandoc-local target to force directory creation before running DOCTEXT
mandoc:
	test -d $(mandoc_path1) || $(MKDIR_P) $(mandoc_path1)
	test -d $(mandoc_path3) || $(MKDIR_P) $(mandoc_path3)
	$(MAKE) $(AM_MAKEFLAGS) mandoc-local
mandoc-local: $(romio_mpi_sources:.c=.man-phony) $(doc1_src_txt:.txt=.man1-phony)

# use htmldoc-local target to force directory creation before running DOCTEXT
htmldoc:
	test -d $(top_builddir)/www/www1 || $(MKDIR_P) $(top_builddir)/www/www1
	test -d $(top_builddir)/www/www3 || $(MKDIR_P) $(top_builddir)/www/www3
	$(MAKE) $(AM_MAKEFLAGS) htmldoc-local
htmldoc-local: $(romio_mpi_sources:.c=.html-phony) $(doc1_src_txt:.txt=.html1-phony)

# --------------------------------------------------------------------------

# sometimes helpful when debugging macros to see the preprocessed output.
# Also using '-CC' because comments provide useful landmarks

SUFFIXES += .i

.c.i:
	$(COMPILE) -CC -E -o $@ $<

